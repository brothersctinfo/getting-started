# name: Build
# on: [push, pull_request]
# jobs:
#   build:
#     name: Build
#     runs-on: ubuntu-latest
#     steps:
#     - uses: actions/checkout@v2
#     - name: Set up Docker Buildx
#       uses: docker/setup-buildx-action@v2
#     - name: Build
#       uses: docker/build-push-action@v3
#       with:
#         push: false

  name: docker-build
  on:
    push:
      branches:
        - 'master'
      tags:
        - 'v[0-9]+.[0-9]+.[0-9]+'

  jobs:
    build:
      runs-on: ubuntu-latest
      env:
        IMG_NAME: ${{ github.repository }} #${{ variables.IMG_NAME }}

      steps:
        -
          name: Checkout 
          uses: actions/checkout@v2
        
        -
          name: Docker metadata
          id: metadata
          uses: docker/metadata-action@v3
          with:
            images: |
              ${{ env.IMG_NAME }}
            tags: |
              type=schedule
              type=ref,event=branch
              type=ref,event=pr
              type=semver,pattern={{version}}
              type=semver,pattern={{major}}.{{minor}}
              type=semver,pattern={{major}}
              type=sha
        -
          name: Login to Jfrog artifactory
          uses: docker/login-action@v1
          with:
            registry: ${{ secrets.JFROG_URL }}
            username: ${{ secrets.JFROG_USERNAME }}
            password: ${{ secrets.JFROG_PASSWORD }}
        -
          name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v1
        # -
        #   name: Build and push
        #   uses: docker/build-push-action@v2
        #   with:
        #     context: .
        #     file: ./Dockerfile
        #     push: true
        #     tags: ${{ secrets.JFROG_URL }}/$IMG_NAME:latest
        # -
        #   name: Build and push Docker image
        #   uses: docker/build-push-action@v2
        #   with:
        #     context: .
        #     push: ${{ github.event.base_ref =='refs/heads/master' && github.ref_type == 'tag' && !startsWith(github.ref, 'refs/tags/v0.')}}
        #     tags: ${{ steps.metadata.outputs.tags }}
        #     labels: ${{ steps.metadata.outputs.labels }}
        -
          name: Build and push
          uses: docker/build-push-action@v2
          with:
            context: .
            platforms: linux/amd64,linux/arm/v7
            push: ${{ github.event_name != 'pull_request' }}
            tags: ${{ steps.<meta_id>.outputs.tags }}
            labels: ${{ steps.<meta_id>.outputs.labels }}

